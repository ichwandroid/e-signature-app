<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - E-Signature Rapor</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script src="https://unpkg.com/qr-code-styling@1.5.0/lib/qr-code-styling.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        #signature-canvas {
            border: 2px dashed #cbd5e1;
            border-radius: 0.5rem;
            cursor: crosshair;
            width: 100%;
            background-color: #fff;
        }
    </style>
</head>
<body class="bg-slate-100 antialiased">

    <!-- Loading state -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/70 backdrop-blur-sm flex items-center justify-center z-50">
        <p class="text-slate-600 font-semibold">Memuat data pengguna...</p>
    </div>

    <!-- Modal Konfirmasi Hapus -->
    <div id="delete-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-md p-6 text-center">
            <div class="mx-auto flex items-center justify-center h-12 w-12 rounded-full bg-red-100">
                <svg class="h-6 w-6 text-red-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
                </svg>
            </div>
            <h3 class="text-lg leading-6 font-medium text-gray-900 mt-4">Hapus Data Tanda Tangan</h3>
            <div class="mt-2">
                <p class="text-sm text-gray-500">Apakah Anda yakin ingin menghapus data ini? Tindakan ini tidak dapat dibatalkan.</p>
            </div>
            <div class="mt-6 flex justify-center gap-4">
                <button type="button" id="cancel-delete-btn" class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50">
                    Batal
                </button>
                <button type="button" id="confirm-delete-btn" class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700">
                    Ya, Hapus
                </button>
            </div>
        </div>
    </div>
    
    <!-- Main Container -->
    <div id="app-container" class="hidden">
        <header class="bg-white shadow-md">
            <div class="max-w-7xl mx-auto py-4 px-4 sm:px-6 lg:px-8 flex justify-between items-center">
                <h1 class="text-xl font-bold text-slate-800">Dashboard Tanda Tangan</h1>
                <div>
                    <span id="user-id-display" class="text-xs text-slate-500 mr-4"></span>
                    <button id="logoutButton" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition-colors">
                        Logout
                    </button>
                </div>
            </div>
        </header>
        <main class="max-w-7xl mx-auto py-6 sm:px-6 lg:px-8">
            <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Buat Tanda Tangan Baru</h2>
                        <form id="signatureForm">
                             <div class="space-y-4">
                                <div>
                                    <label for="signerName" class="block text-sm font-medium text-slate-700">Nama Penanda Tangan</label>
                                    <input type="text" id="signerName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="foundationId" class="block text-sm font-medium text-slate-700">Nomer Induk Yayasan (NIY)</label>
                                    <input type="text" id="foundationId" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="position" class="block text-sm font-medium text-slate-700">Jabatan</label>
                                    <input type="text" id="position" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="decreeNumber" class="block text-sm font-medium text-slate-700">Nomer SK</label>
                                    <input type="text" id="decreeNumber" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label for="documentName" class="block text-sm font-medium text-slate-700">Nama Dokumen</label>
                                    <input type="text" id="documentName" required class="mt-1 block w-full px-3 py-2 bg-white border border-slate-300 rounded-md shadow-sm">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-700">Tanda Tangan</label>
                                    <canvas id="signature-canvas" height="200"></canvas>
                                    <div class="mt-2">
                                        <button type="button" id="clearSignature" class="text-sm text-slate-600 hover:text-slate-800">Hapus Tanda Tangan</button>
                                    </div>
                                </div>
                            </div>
                            <div class="mt-6">
                                <button type="submit" id="saveSignature" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                                    Simpan
                                </button>
                            </div>
                            <div id="form-feedback" class="mt-4 text-sm text-center"></div>
                        </form>
                    </div>
                </div>
                <div class="lg:col-span-3">
                     <div class="bg-white p-6 rounded-xl shadow-lg min-h-full">
                        <h2 class="text-lg font-bold text-slate-800 mb-4">Data Tanda Tangan Tersimpan</h2>
                        <div id="signatureList" class="space-y-4">
                            <p class="text-slate-500 text-center py-8">Memuat data...</p>
                        </div>
                     </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, collection, addDoc, onSnapshot, setDoc, serverTimestamp, query, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // GANTI DENGAN KONFIGURASI FIREBASE ANDA
        const firebaseConfig = {
            apiKey: "AIzaSyB_eFnAlQDAABFc_F_Vzaj3gfiynp-e5OQ",
            authDomain: "sekolahanaksaleh-esign.firebaseapp.com",
            projectId: "sekolahanaksaleh-esign",
            storageBucket: "sekolahanaksaleh-esign.appspot.com",
            messagingSenderId: "196646097242",
            appId: "1:196646097242:web:e50cec36c234f35c9ca363",
        };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-e-signature-app';
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let userId, signaturePad;
        let currentUserLogoUrl; 

        const ui = {
            loadingOverlay: document.getElementById('loading-overlay'),
            appContainer: document.getElementById('app-container'),
            logoutButton: document.getElementById('logoutButton'),
            userIdDisplay: document.getElementById('user-id-display'),
            signatureForm: document.getElementById('signatureForm'),
            clearSignatureButton: document.getElementById('clearSignature'),
            saveSignatureButton: document.getElementById('saveSignature'),
            formFeedback: document.getElementById('form-feedback'),
            signatureList: document.getElementById('signatureList'),
            deleteModal: {
                modal: document.getElementById('delete-modal'),
                confirmBtn: document.getElementById('confirm-delete-btn'),
                cancelBtn: document.getElementById('cancel-delete-btn')
            }
        };

        onAuthStateChanged(auth, user => {
            if (user) {
                userId = user.uid;
                ui.userIdDisplay.textContent = `User ID: ${userId}`;

                // --- Logika untuk Logo Khusus PAUD ---
                const PAUD_EMAIL = 'paud@sekolahanaksaleh.sch.id';
                
                // GANTI DENGAN URL LOGO ANDA
                const PAUD_LOGO_URL = 'https://i.imgur.com/4M3RIZo.png'; // <-- GANTI URL LOGO PAUD
                const DEFAULT_LOGO_URL = 'https://i.imgur.com/8Ksu8Dz.png'; // <-- GANTI URL LOGO SEKOLAH BIASA

                if (user.email === PAUD_EMAIL) {
                    currentUserLogoUrl = PAUD_LOGO_URL;
                } else {
                    currentUserLogoUrl = DEFAULT_LOGO_URL;
                }

                ui.loadingOverlay.classList.add('hidden');
                ui.appContainer.classList.remove('hidden');
                initializeDashboard();
                listenToSignatures();
            } else {
                window.location.href = './index.html';
            }
        });

        function initializeDashboard() {
            const canvas = document.getElementById("signature-canvas");
            const ctx = canvas.getContext("2d");
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            ctx.scale(ratio, ratio);
            
            const stampImageUrl = "https://i.ibb.co/7jJST4v/stamp-example.png";
            const stampImage = new Image();
            stampImage.crossOrigin = "anonymous";
            stampImage.src = stampImageUrl;

            const resetCanvasWithStamp = () => {
                ctx.clearRect(0, 0, canvas.offsetWidth, canvas.offsetHeight);
                const stampWidth = 100, stampHeight = 100;
                const x = (canvas.offsetWidth / 2) - (stampWidth / 2);
                const y = (canvas.offsetHeight / 2) - (stampHeight / 2);
                ctx.drawImage(stampImage, x, y, stampWidth, stampHeight);
            };

            stampImage.onload = () => {
                resetCanvasWithStamp();
                signaturePad = new SignaturePad(canvas, { backgroundColor: "rgba(255, 255, 255, 0)" });
                ui.clearSignatureButton.addEventListener("click", () => {
                    signaturePad.clear();
                    resetCanvasWithStamp();
                });
            };
            stampImage.onerror = () => {
                console.error("Gagal memuat gambar stempel.");
                signaturePad = new SignaturePad(canvas, { backgroundColor: "rgb(255, 255, 255)" });
                ui.clearSignatureButton.addEventListener("click", () => signaturePad.clear());
            };
            
            ui.signatureForm.addEventListener("submit", handleSaveSignature);
            ui.logoutButton.addEventListener("click", () => signOut(auth));
        }

        async function handleSaveSignature(e) {
            e.preventDefault();
            if (signaturePad.isEmpty()) {
                alert("Tanda tangan tidak boleh kosong.");
                return;
            }

            ui.saveSignatureButton.disabled = true;
            ui.saveSignatureButton.textContent = 'Menyimpan...';

            try {
                const canvas = signaturePad.canvas;
                const ctx = canvas.getContext("2d");
                const validationId = crypto.randomUUID(); 
                const watermarkText = `ID: ${validationId.substring(0, 8)} | ${new Date().toLocaleDateString('id-ID')}`;

                ctx.save();
                ctx.font = '10px Arial';
                ctx.fillStyle = 'rgba(0, 0, 0, 0.25)';
                ctx.textAlign = 'right';
                ctx.textBaseline = 'bottom';
                
                const ratio = Math.max(window.devicePixelRatio || 1, 1);
                ctx.fillText(watermarkText, (canvas.width / ratio) - 5, (canvas.height / ratio) - 5);
                ctx.restore();

                const signatureImage = signaturePad.toDataURL('image/png');

                const signatureData = {
                    signerName: document.getElementById('signerName').value,
                    foundationId: document.getElementById('foundationId').value,
                    position: document.getElementById('position').value,
                    decreeNumber: document.getElementById('decreeNumber').value,
                    documentName: document.getElementById('documentName').value,
                    signatureImage,
                    validationId,
                    createdAt: serverTimestamp(),
                    authorId: userId
                };
                
                const privateCollectionPath = `/artifacts/${appId}/users/${userId}/signatures`;
                const publicDocPath = `/artifacts/${appId}/public/data/validations/${validationId}`;

                await addDoc(collection(db, privateCollectionPath), signatureData);
                await setDoc(doc(db, publicDocPath), signatureData);

                ui.formFeedback.textContent = 'Data berhasil disimpan!';
                ui.formFeedback.className = 'mt-4 text-sm text-center text-green-600';
                ui.signatureForm.reset();
                document.getElementById('clearSignature').click();
            } catch (error) {
                console.error("Save Error:", error);
                ui.formFeedback.textContent = 'Gagal menyimpan data.';
                ui.formFeedback.className = 'mt-4 text-sm text-center text-red-600';
            } finally {
                ui.saveSignatureButton.disabled = false;
                ui.saveSignatureButton.textContent = 'Simpan';
                setTimeout(() => ui.formFeedback.textContent = '', 3000);
            }
        }

        function openDeleteModal(docId, validationId) {
            ui.deleteModal.modal.classList.remove('hidden');
            ui.deleteModal.confirmBtn.dataset.docId = docId;
            ui.deleteModal.confirmBtn.dataset.validationId = validationId;
        }
        function closeDeleteModal() {
            ui.deleteModal.modal.classList.add('hidden');
        }
        async function handleDeleteSignature(docId, validationId) {
            if (!docId || !validationId) return;
            ui.deleteModal.confirmBtn.disabled = true;
            ui.deleteModal.confirmBtn.textContent = 'Menghapus...';
            try {
                const privateDocRef = doc(db, `/artifacts/${appId}/users/${userId}/signatures`, docId);
                await deleteDoc(privateDocRef);
                const publicDocRef = doc(db, `/artifacts/${appId}/public/data/validations`, validationId);
                await deleteDoc(publicDocRef);
            } catch (error) {
                console.error("Error deleting document: ", error);
                alert("Gagal menghapus data.");
            } finally {
                ui.deleteModal.confirmBtn.disabled = false;
                ui.deleteModal.confirmBtn.textContent = 'Ya, Hapus';
                closeDeleteModal();
            }
        }
        
        ui.signatureList.addEventListener('click', (e) => {
            const deleteButton = e.target.closest('.delete-btn');
            if (deleteButton) {
                const docId = deleteButton.dataset.docId;
                const validationId = deleteButton.dataset.validationId;
                openDeleteModal(docId, validationId);
            }
        });
        ui.deleteModal.cancelBtn.addEventListener('click', closeDeleteModal);
        ui.deleteModal.confirmBtn.addEventListener('click', (e) => {
            const { docId, validationId } = e.currentTarget.dataset;
            handleDeleteSignature(docId, validationId);
        });

        function listenToSignatures() {
            if (!userId) return;
            const q = query(collection(db, `/artifacts/${appId}/users/${userId}/signatures`));
            
            onSnapshot(q, (snapshot) => {
                if (snapshot.empty) {
                    ui.signatureList.innerHTML = `<p class="text-slate-500 text-center py-8">Belum ada data.</p>`;
                    return;
                }
                
                ui.signatureList.innerHTML = '';
                const docs = snapshot.docs.sort((a,b) => (b.data().createdAt?.toMillis() || 0) - (a.data().createdAt?.toMillis() || 0));

                docs.forEach(docSnap => {
                    const data = docSnap.data();
                    const card = createSignatureCard(docSnap.id, data);
                    ui.signatureList.appendChild(card);
                    
                    const qrCodeEl = document.getElementById(`qr-${docSnap.id}`);
                    const validationUrl = `${window.location.origin}/validasi.html?id=${data.validationId}`;
                    
                    const qrCodeOptions = {
                        width: 170, height: 170, type: 'svg', data: validationUrl,
                        image: currentUserLogoUrl,
                        dotsOptions: { color: '#3730a3', type: 'rounded' },
                        imageOptions: { crossOrigin: 'anonymous', margin: 10, imageSize: 0.4 },
                    };
                    const qrCode = new QRCodeStyling(qrCodeOptions);
                    qrCode.append(qrCodeEl);

                    const downloadButton = document.getElementById(`download-qr-${docSnap.id}`);
                    if (downloadButton) {
                        downloadButton.addEventListener('click', () => {
                            const qrCodeDownloader = new QRCodeStyling({ ...qrCodeOptions, width: 1000, height: 1000 });
                            const filename = `qrcode-${data.documentName.replace(/[^a-z0-9]/gi, '_').toLowerCase()}`;
                            qrCodeDownloader.download({ name: filename, extension: 'png' });
                        });
                    }
                });
            });
        }

        function createSignatureCard(id, data) {
            const card = document.createElement('div');
            card.className = 'p-4 border border-slate-200 rounded-lg bg-slate-50 flex flex-col sm:flex-row gap-4';
            const timestamp = data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString('id-ID') : 'N/A';
            card.innerHTML = `
                <div class="flex-grow">
                    <p class="font-bold text-indigo-700">${data.documentName}</p>
                    <p class="text-sm text-slate-600">Oleh: <strong>${data.signerName}</strong> (${data.position})</p>
                    <p class="text-xs text-slate-400 mt-1">Dibuat pada: ${timestamp}</p>
                </div>
                <div class="flex flex-col items-center p-2 bg-white rounded-md shadow-inner self-start">
                    <div id="qr-${id}"></div>
                    <p class="text-xs text-slate-500 mt-2">Scan untuk validasi</p>
                    <div class="flex items-center gap-2 mt-2">
                        <button id="download-qr-${id}" class="text-xs bg-gray-200 text-gray-800 font-medium py-1 px-3 rounded-full hover:bg-gray-300 transition-colors">
                            Download
                        </button>
                        <button 
                            class="delete-btn text-red-500 hover:text-red-700 p-1 rounded-full hover:bg-red-100 transition-colors"
                            data-doc-id="${id}"
                            data-validation-id="${data.validationId}"
                            title="Hapus Tanda Tangan"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                            </svg>
                        </button>
                    </div>
                </div>`;
            return card;
        }

    </script>
</body>
</html>

